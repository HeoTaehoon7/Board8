<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.board.pds.mapper.PdsMapper">  
  
  <!-- 전체 자료수 -->
  <select  id="count">
  
     SELECT  COUNT(*)  AS CNT
      FROM   BOARD
      WHERE  MENU_ID = #{ menu_id  }
  
  </select>
   
  <select id="getPdsList" >
  
  	SELECT
  	    IDX,
  	    TITLE,
  	    WRITER,
  	    -- 상관서브쿼리 ( CORELATIVE )
  	    (  
  	       SELECT   COUNT(*)
  	        FROM    FILES  F
  	        WHERE   B.IDX = F.IDX
  	    )   FILESCOUNT,
  	    TO_CHAR( REGDATE, 'YYYY-MM-DD') REGDATE, 
  	    HIT
  	 FROM
  	    BOARD  B
  	    
     <where>
         <if test="menu_id != null and menu_id !=''">
               AND MENU_ID = #{menu_id}             
         </if>
         <if test="title != null and title !=''">
               AND TITLE = #{title}             
         </if>
         <if test="writer != null and writer !=''">
               AND WRITER = #{writer}             
         </if>
         <if test="content != null and content !=''">
               AND CONTENT = #{content}             
         </if>
       </where>
       
  	 ORDER BY  
  	    IDX  DESC 
  	 OFFSET #{ offset } ROWS FETCH NEXT #{ recordSize } ROWS ONLY   
  
  </select>
  
  <insert  id="setWrite">
    INSERT INTO BOARD (
	    IDX,
	    MENU_ID,
	    TITLE,
	    CONTENT,
	    WRITER,
	    REGDATE,
	    HIT
	) VALUES (
	    ( SELECT NVL(MAX(IDX),0)+1 FROM BOARD ),
	    #{ menu_id } , 
	    #{ title   } ,
	    #{ content } ,
	    #{ writer  } ,
	    sysdate,
	    0
	)
  </insert>
  
  <insert  id="setFileWriter">
  
    <foreach  collection="fileList"  item = "file"
       index      =  "i"
       open       =  "INSERT ALL"
       close      =  "SELECT * FROM DUAL"  
       separator  =  " "  >
       INTO FILES VALUES (  
          ( SELECT NVL(MAX(FILE_NUM), 0) FROM FILES ) + #{i} + 1,
          ( SELECT MAX(IDX) FROM BOARD ),
          #{ file.filename  },
          #{ file.fileext   },
          #{ file.sfilename }
       )       
           
    </foreach>
  
  </insert>
 
  
</mapper>

















